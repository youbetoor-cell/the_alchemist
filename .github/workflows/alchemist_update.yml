name: ğŸ” Update The Alchemist Data

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install jq

      - name: ğŸ§™ Run The Alchemist agents
        run: python main.py

      - name: ğŸ’¾ Commit & push updates
        run: |
          git config user.name "The Alchemist Bot"
          git config user.email "bot@thealchemist.ai"
          git add data/summary.json data/reports/*.json || true
          git commit -m "Auto-update $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push || echo "No push changes"

      - name: ğŸ“£ Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            TOP=$(jq -r '.details | max_by(.score) | .name' data/summary.json)
            SCORE=$(jq -r '.details | max_by(.score) | .score' data/summary.json)
            MESSAGE="ğŸ§™â€â™‚ï¸ *The Alchemist Update Complete!* \
            \nTop Performer: *$TOP* â€” Score: *$SCORE* \
            \nTime: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" "$SLACK_WEBHOOK_URL"
          fi

          # Fetch AI sentiment (via OpenAI API)
          SENTIMENT=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are The Alchemist AI. Reply with one word sentiment (ğŸŸ¢ bullish / ğŸ”´ bearish / âšª neutral) and 4-6 words of explanation.\"},
                {\"role\": \"user\", \"content\": \"Analyze domain $TOP_DOMAIN with summary: $SUMMARY\"}
              ],
              \"max_tokens\": 25
            }" | jq -r '.choices[0].message.content')

          # Compose Slack message
          MESSAGE="ğŸ§™â€â™‚ï¸ *The Alchemist has forged new insights!*
          \nğŸ† *Top Performer:* ${TOP_DOMAIN^} (score $TOP_SCORE)
          \nğŸ”® *AI Sentiment:* $SENTIMENT
          \nğŸ“Š *Next update:* in 1 hour"

          # Send Slack message
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL"
          else
            echo "âš ï¸ No Slack webhook found, skipping notification."
          fi
