name: üîÅ Update The Alchemist Data

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: üßô Run The Alchemist agents
        run: python main.py

      - name: üíæ Commit & push updates
        run: |
          git config user.name "The Alchemist Bot"
          git config user.email "bot@thealchemist.ai"
          git add data/summary.json data/reports/*.json || true
          git commit -m "Auto-update $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push || echo "No push changes"

      - name: üóìÔ∏è Save last update message
        run: |
          echo "$(date -u +'%Y-%m-%d %H:%M:%S') UTC ‚Äî The Alchemist update complete." > data/last_update.txt
          git add data/last_update.txt
          git commit -m "Log: update timestamp" || echo "No changes"
          git push || echo "No push changes"

      - name: üì£ Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            TOP=$(jq -r '.details | max_by(.score) | .name' data/summary.json)
            SCORE=$(jq -r '.details | max_by(.score) | .score' data/summary.json)
            SUMMARY=$(jq -r ".details[] | select(.name==\"$TOP\") | .summary" data/summary.json)
            
            # Ask OpenAI for sentiment
            SENTIMENT=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4o-mini\",
                \"messages\": [
                  {\"role\": \"system\", \"content\": \"You are The Alchemist AI. Reply with one word sentiment (üü¢ bullish / üî¥ bearish / ‚ö™ neutral) and a 5-word summary.\"},
                  {\"role\": \"user\", \"content\": \"Analyze domain $TOP with summary: $SUMMARY\"}
                ],
                \"max_tokens\": 25
              }" | jq -r '.choices[0].message.content')

            MESSAGE="üßô‚Äç‚ôÇÔ∏è *The Alchemist Update Complete!* \
            \nüèÜ *Top Performer:* ${TOP^} ‚Äî Score: *$SCORE* \
            \nüîÆ *AI Sentiment:* $SENTIMENT \
            \nüïí *Time:* $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

            # Save message for dashboard
            echo "$MESSAGE" > data/last_update.txt
            git add data/last_update.txt
            git commit -m "Update last Slack message" || echo "No changes"
            git push || echo "No push changes"

            # Send Slack message
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" "$SLACK_WEBHOOK_URL"
          else
            echo "‚ö†Ô∏è No Slack webhook found, skipping notification."
          fi
